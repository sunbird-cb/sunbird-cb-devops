





---
- name: Taking Cassandra Snapshots
  shell: |
    nodetool clearsnapshot
    nodetool snapshot -t "cassandra-backup-{{ lookup('pipe', 'date +%Y%m%d') }}-{{ ansible_hostname }}-new"
  ignore_errors: yes

- name: Compressing and Uploading Snapshots
  shell: |
    cd {{ backup_directory }}
    find . -type d -name '*cassandra-backup*' -exec tar -czvf {}.tar.gz {} \;
    find . -type d -name '*cassandra-backup*' -exec rm -rf {} \;
    rsync -avz --remove-source-files {{ backup_directory }}/*.tar.gz {{ nfs_mount_path }}
  ignore_errors: yes
